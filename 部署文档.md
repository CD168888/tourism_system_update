# 旅游信息系统 - Nginx 部署文档

## 一、环境准备

### 1.1 软件要求

- **Nginx**: 1.18+
- **JDK**: 17 (路径: `C:\Program Files\Java\jdk-17.0.12`)
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **Maven**: 3.6+
- **Node.js**: 14+

### 1.2 数据库准备

- 数据库名: `tourism_system`
- 导入 SQL 脚本: `springboot/ai_chat_v2.sql`

---

## 二、后端打包部署

### 2.1 修改生产环境配置

编辑 `springboot/src/main/resources/application.properties`，确认以下配置：

```properties
# 服务器端口
server.port=1236

# 数据库配置（根据生产环境修改）
spring.datasource.url=jdbc:mysql://localhost:3306/tourism_system?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true&useSSL=false&serverTimezone=GMT%2b8&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=123456

# Redis配置（根据生产环境修改）
spring.data.redis.host=39.97.235.40
spring.data.redis.port=6379

# 支付宝回调地址（修改为实际域名）
alipay.returnUrl=http://yourdomain.com/payment/result
alipay.notifyUrl=http://yourdomain.com/alipay/notify
```

### 2.2 Maven 打包

在 `springboot` 目录下执行：

```bash
cd springboot
mvn clean package -DskipTests
```

打包成功后，jar 包位置：`springboot/target/springboot-0.0.1-SNAPSHOT.jar`

### 2.3 启动后端服务

**Windows 启动：**

```bash
cd springboot/target
java -jar springboot-0.0.1-SNAPSHOT.jar
```

**Linux 后台启动：**

```bash
nohup java -jar springboot-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
```

**验证启动：**
访问 http://localhost:1236/doc.html 查看 API 文档

---

## 三、前端打包部署

### 3.1 修改生产环境配置

编辑 `vue3/.env.production`：

```env
# 生产环境API地址（使用nginx代理，相对路径）
VUE_APP_BASE_API = '/api'
```

### 3.2 npm 打包

在 `vue3` 目录下执行：

```bash
cd vue3
npm install
npm run build
```

打包成功后，生成的文件在：`vue3/dist`

---

## 四、Nginx 配置部署

### 4.1 安装 Nginx

**Windows:**

1. 下载 Nginx: http://nginx.org/en/download.html
2. 解压到指定目录，如: `C:\nginx`

**Linux (Ubuntu/Debian):**

```bash
sudo apt update
sudo apt install nginx
```

**Linux (CentOS/RHEL):**

```bash
sudo yum install nginx
```

### 4.2 配置 Nginx

#### Windows 配置：

1. 将项目根目录的 `nginx.conf` 复制到 `C:\nginx\conf\nginx.conf`（覆盖原文件）
2. 将前端打包文件 `vue3/dist` 复制到 `C:\nginx\html\dist`

#### Linux 配置：

1. 备份原配置：

```bash
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup
```

2. 将项目 `nginx.conf` 内容复制到 `/etc/nginx/nginx.conf`

3. 复制前端文件：

```bash
sudo mkdir -p /usr/share/nginx/html/dist
sudo cp -r vue3/dist/* /usr/share/nginx/html/dist/
```

### 4.3 配置说明

```nginx
# 端口80，外部访问入口
listen 80;

# 前端静态资源位置
location / {
    root   html/dist;  # Windows: C:\nginx\html\dist
                       # Linux: /usr/share/nginx/html/dist
    try_files $uri $uri/ /index.html;
}

# API代理到后端服务
location /api/ {
    proxy_pass http://127.0.0.1:1236/api/;
}

# 静态资源（图片）代理到后端
location /img/ {
    proxy_pass http://127.0.0.1:1236/img/;
}
```

### 4.4 启动 Nginx

**Windows:**

```bash
cd C:\nginx
start nginx
```

**重启 Nginx:**

```bash
nginx -s reload
```

**停止 Nginx:**

```bash
nginx -s stop
```

**Linux:**

```bash
# 启动
sudo systemctl start nginx

# 重启
sudo systemctl reload nginx

# 停止
sudo systemctl stop nginx

# 开机自启
sudo systemctl enable nginx
```

### 4.5 验证 Nginx 配置

```bash
# Windows
nginx -t

# Linux
sudo nginx -t
```

---

## 五、访问系统

### 5.1 访问地址

- **前端首页**: http://localhost 或 http://服务器 IP
- **后端 API 文档**: http://localhost/doc.html
- **默认管理员账号**: admin / admin

### 5.2 防火墙配置（生产环境）

**Windows 防火墙：**

1. 打开"高级安全 Windows 防火墙"
2. 新建入站规则，开放 TCP 80 端口

**Linux 防火墙：**

```bash
# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload

# Ubuntu (ufw)
sudo ufw allow 80/tcp
sudo ufw reload
```

---

## 六、常见问题

### 6.1 Nginx 启动失败

- **检查端口占用**: `netstat -ano | findstr :80` (Windows) 或 `sudo netstat -tlnp | grep :80` (Linux)
- **检查配置语法**: `nginx -t`
- **查看错误日志**: `C:\nginx\logs\error.log` (Windows) 或 `/var/log/nginx/error.log` (Linux)

### 6.2 API 请求 404

- 确认后端服务已启动（端口 1236）
- 检查 nginx 配置中的 `proxy_pass` 地址
- 查看 nginx 错误日志

### 6.3 页面加载空白

- 检查 `vue3/.env.production` 中的 `VUE_APP_BASE_API` 是否为 `/api`
- 确认前端 dist 文件已正确复制到 nginx 的 html/dist 目录
- 浏览器 F12 查看控制台错误

### 6.4 静态资源（图片）加载失败

- 确认后端 `application.properties` 配置了静态资源路径映射
- 检查 nginx 的 `/img/` 代理配置

### 6.5 跨域问题

- nginx 配置已包含跨域头，如仍有问题检查后端 CORS 配置

---

## 七、生产环境优化建议

### 7.1 后端优化

- 使用 `spring.profiles.active=prod` 区分生产环境
- 配置日志级别为 `WARN` 或 `ERROR`
- 启用 JVM 优化参数：

```bash
java -Xms512m -Xmx1024m -jar springboot-0.0.1-SNAPSHOT.jar
```

### 7.2 前端优化

- 已启用 gzip 压缩
- 考虑使用 CDN 加速静态资源
- 配置浏览器缓存

### 7.3 安全加固

- 修改默认管理员密码
- 配置 HTTPS (SSL 证书)
- 限制 Swagger 文档访问（生产环境可关闭）
- 定期备份数据库

### 7.4 监控

- 配置日志收集
- 监控服务器资源（CPU、内存、磁盘）
- 监控应用健康状态

---

## 八、目录结构（部署后）

```
生产服务器
├── nginx/                      # Nginx安装目录
│   ├── conf/
│   │   └── nginx.conf         # Nginx配置文件
│   ├── html/
│   │   └── dist/              # 前端打包文件
│   └── logs/                  # Nginx日志
│
├── app/                       # 应用部署目录（建议）
│   ├── springboot-0.0.1-SNAPSHOT.jar  # 后端jar包
│   ├── app.log               # 应用日志
│   └── static/               # 上传的静态资源（如有）
│
└── mysql/                    # 数据库
    └── tourism_system        # 数据库
```

---

## 九、部署检查清单

- [ ] JDK 17 已安装并配置环境变量
- [ ] MySQL 数据库已创建并导入 SQL 脚本
- [ ] Redis 服务已启动
- [ ] 后端 application.properties 配置已修改
- [ ] 后端 jar 包已打包
- [ ] 后端服务已启动（端口 1236）
- [ ] 前端.env.production 配置已修改
- [ ] 前端已打包生成 dist 目录
- [ ] Nginx 已安装
- [ ] nginx.conf 已配置
- [ ] 前端 dist 文件已复制到 nginx 目录
- [ ] Nginx 已启动
- [ ] 防火墙已开放 80 端口
- [ ] 浏览器访问测试通过

---

## 联系方式

如有问题，请参考项目 README 或联系开发团队。
